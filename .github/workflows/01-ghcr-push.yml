name: "01 - Push to GHCR"

on:
  workflow_dispatch:
  push:
    branches: ["main"]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4

      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "Log in to GitHub Container Registry"
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Extract metadata"
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest

      - name: "Build and push Docker image"
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: "Final Step"
        run: echo "Image pushed to GHCR successfully! ‚úÖ"

  test:
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4

      - name: "Set up Python"
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: "Install dependencies"
        run: pip install -r requirements.txt pytest

      - name: "Run pytest"
        run: pytest -v

      - name: "Build Docker image for testing"
        run: docker build -t flask-app-test:latest .

      - name: "Start Flask app in container"
        run: |
          docker run -d \
            --name flask-test-container \
            -p 5000:5000 \
            flask-app-test:latest
          sleep 3

      - name: "Test Health Check Endpoint"
        run: |
          echo "Testing GET /"
          curl -s -w "\nStatus: %{http_code}\n" http://localhost:5000/

      - name: "Test AI Endpoint"
        run: |
          echo "Testing GET /AI"
          curl -s -w "\nStatus: %{http_code}\n" http://localhost:5000/AI

      - name: "Test POST with Form Data"
        run: |
          echo "Testing POST / with form data"
          curl -s -w "\nStatus: %{http_code}\n" \
            -X POST \
            -d "name=TestUser" \
            http://localhost:5000/

      - name: "Verify JSON response from AI endpoint"
        run: |
          RESPONSE=$(curl -s http://localhost:5000/AI)
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q '"message"'; then
            echo "‚úÖ JSON response verified!"
          else
            echo "‚ùå JSON response not found!"
            exit 1
          fi

      - name: "Stop container"
        if: always()
        run: docker stop flask-test-container || true

      - name: "Test Summary"
        run: echo "All tests completed successfully! üöÄ"
